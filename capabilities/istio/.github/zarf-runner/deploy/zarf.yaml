kind: ZarfPackageConfig
metadata:
  name: farmer-pickles
  url: https://welovebob.com/characters/farmer_pickles.htm
  image: https://welovebob.com/Images/characters/farmer_pickles.jpg
  description: "A zarf package to deploy things"

components:
  - name: deploy
    required: true
    actions:
      onCreate:
        before:
          - description: Deploy the test cluster package
            cmd: ./zarf p d oci://defenseunicorns/uds-k3d:0.1.10-multi --confirm
            dir: ../build
          - description: deploy the init package to the cluster
            cmd: |
              ARCH=$(uname -m)
              [ "$ARCH" = "x86_64" ] && ARCH="amd64"
              ./zarf p d oci://ghcr.io/defenseunicorns/packages/init:v0.31.0-$ARCH --confirm
          - description: Deploy the istio
            cmd: |
              ARCH=$(uname -m)
              [ "$ARCH" = "x86_64" ] && ARCH="amd64"
              ./zarf p d ../build/zarf-package-uds-capability-istio-$ARCH.tar.zst  --confirm --components "istio-controlplane,istio-admin-gateway,istio-tenant-gateway,istio-passthrough-gateway,module"

          - description: Inject tls certificate
            cmd: |
              npm ci
              npx --yes ts-node examples/tls-certs.ts
            dir: ../../../../../
        after:
          - description: Wait for the istio gateway to have the label required for vs generation.
            wait:
              cluster:
                kind: Gateway
                name: uds/istio-domain=uds.dev
                namespace: istio-tenant-gateway
