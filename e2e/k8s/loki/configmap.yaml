# Copyright 2024 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-shared-scripts
  namespace: loki
data:
  check_logs.sh: |
    #!/bin/sh
    retries=${RETRIES:-5}
    delay=${DELAY:-5}
    start_time=$(($(date +%s) - 300))000000000
    end_time=$(date +%s%N)

    for i in $(seq 1 $retries); do
      response=$(curl -sG "http://loki-read.loki.svc.cluster.local:3100/loki/api/v1/query_range" \
        --data-urlencode "query=$QUERY" \
        --data-urlencode "limit=10" \
        --data-urlencode "start=$start_time" \
        --data-urlencode "end=$end_time")

      if ! echo "$response" | grep -q '"result":\[\]'; then
        echo "Validated: $LOG_MESSAGE found in Loki."
        exit 0
      else
        echo "Log not found, retrying in $delay seconds... (Attempt $i of $retries)"
        sleep $delay
      fi
    done

    echo "$LOG_MESSAGE not found in Loki after $retries attempts."
    exit 1

  send_log.sh: |
    #!/bin/sh
    timestamp=$1
    log_message=$2
    curl -sX POST http://loki-write.loki.svc.cluster.local:3100/loki/api/v1/push \
      -H "Content-Type: application/json" \
      --data-raw '{
        "streams": [
          {
            "stream": {
              "collector": "vector",
              "job": "'"$LOG_JOB"'"
            },
            "values": [
              ["'"$timestamp"'", "'"$log_message"'"]
            ]
          }
        ]
      }'
