# Copyright 2024 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

tasks:
  - name: cashbuster
    actions:
      - cmd: date +%s | base64 | cut -c1-10
        setVariables:
          - name: TAG
  - name: build
    description: "Build and publish the test images"
    actions:
      - cmd: docker build -t rjferguson21:${TAG} . --no-cache
      - cmd: uds zarf dev deploy --create-set=IMAGE=${TAG} --no-yolo .
  - name: run
    description: "Run tests"
    actions:
      - cmd: kubectl apply -f egress-anywhere.yaml
      - cmd: uds zarf tools kubectl run foo -n monitoring --labels="app=tests" --labels="batch.kubernetes.io/job-name=tests" --image="rjferguson21:${TAG}" -q --restart=Never --rm -i
      - cmd: kubectl delete -f egress-anywhere.yaml
  - name: test
    actions:
      - task: cashbuster
      - task: build
      - task: run
