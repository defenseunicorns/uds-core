# Copyright 2024 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

{{- if .Capabilities.APIVersions.Has "security.istio.io/v1beta1" }}
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: keycloak
  namespace: {{ .Release.Namespace }}
spec:
  mtls:
    mode: STRICT
  selector:
    matchLabels:
      app.kubernetes.io/name: keycloak
  portLevelMtls:
    # Keycloak 26.2.0 introduced transport layer encryption for cache (Infinispan) connections. This requires
    # to disable mTLS at Istio layer
    # See:
    # - https://www.keycloak.org/server/caching#_running_inside_a_service_mesh
    # - https://github.com/keycloak/keycloak/issues/39454
    "7800":
      mode: PERMISSIVE
    # Below array of ports is required as JGroups probe the entire range of Transport Ports with DNS_PING.
    # Other cluster members might listen on any of them.
    # See:
    # - https://github.com/belaban/JGroups/blob/master/src/org/jgroups/protocols/dns/DNS_PING.java#L168-L169
    # - Trace logs from a living cluster:
    #   2025-05-06 07:34:23,226 DEBUG [org.jgroups.protocols.dns.DNS_PING] () keycloak-2-51586: sending discovery requests to hosts [10.42.0.71:0, 10.42.0.72:0, 10.42.0.73:0] on ports [7800 .. 7810]
    # This will go away once we switch to JDBC_PING2
    "7801":
      mode: PERMISSIVE
    "7802":
      mode: PERMISSIVE
    "7803":
      mode: PERMISSIVE
    "7804":
      mode: PERMISSIVE
    "7805":
      mode: PERMISSIVE
    "7806":
      mode: PERMISSIVE
    "7807":
      mode: PERMISSIVE
    "7808":
      mode: PERMISSIVE
    "7809":
      mode: PERMISSIVE
    "7810":
      mode: PERMISSIVE

{{- end }}
