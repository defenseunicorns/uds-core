apiVersion: uds.dev/v1alpha1
kind: Package
metadata:
  name: keycloak-gitlab-emulate
  namespace: {{ .Release.Namespace }}
spec:
  network:
    expose:
      - description: "authorize endpoint"
        service: keycloak-http
        selector:
          app.kubernetes.io/name: keycloak
        host: sso
        port: 8080
        advancedHTTP:
          match:
            - name: gitlab-authorize
              uri:
                prefix: /oauth/authorize
          rewrite:
            uri: "/realms/{{ .Values.realm }}/protocol/openid-connect/auth"

      - description: "user endpoint"
        service: keycloak-http
        selector:
          app.kubernetes.io/name: keycloak
        host: sso
        port: 8080
        advancedHTTP:
          match:
            - name: gitlab-user
              uri:
                prefix: /api/v4/user
          rewrite:
            uri: "/realms/{{ .Values.realm }}/protocol/openid-connect/userinfo"

      - description: "token endpoint"
        service: keycloak-http
        selector:
          app.kubernetes.io/name: keycloak
        host: sso
        port: 8080
        advancedHTTP:
          match:
            - name: gitlab-token
              uri:
                prefix: /oauth/token
          rewrite:
            uri: "/realms/{{ .Values.realm }}/protocol/openid-connect/token"
