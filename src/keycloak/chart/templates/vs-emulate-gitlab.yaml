{{- if .Capabilities.APIVersions.Has "security.istio.io/v1beta1" }}
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: emulate-gitlab
  namespace: {{ .Release.Namespace }}
spec:
  hosts:
    - "sso.{{ .Values.domain }}"
  gateways:
    - istio-tenant-gateway/tenant-gateway
  http:
    - match:
        - uri:
            prefix: /oauth/authorize
      route:
        - destination:
            host: keycloak-http.keycloak.svc.cluster.local
            port:
              number: 8080
      rewrite:
        uri: "/realms/{{ .Values.realm }}/protocol/openid-connect/auth"
    - match:
        - uri:
            prefix: /api/v4/user
      route:
        - destination:
            host: keycloak-http.keycloak.svc.cluster.local
            port:
              number: 8080
      rewrite:
        uri: "/realms/{{ .Values.realm }}/protocol/openid-connect/userinfo"
    - match:
        - uri:
            prefix: /oauth/token
      route:
        - destination:
            host: keycloak-http.keycloak.svc.cluster.local
            port:
              number: 8080
      rewrite:
        uri: "/realms/{{ .Values.realm }}/protocol/openid-connect/token"
{{- end }}  