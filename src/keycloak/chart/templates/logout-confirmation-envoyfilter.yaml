# Copyright 2025 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

{{- if .Values.logoutConfirmation }}
# Enforce logout confirmation by renaming `post_logout_redirect_uri` to `uds_post_logout_redirect_uri` on logout URLs
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: enforce-logout-confirmation
  namespace: istio-system
spec:
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.lua
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
            inlineCode: |
              function envoy_on_request(request_handle)
                local headers = request_handle:headers()
                local path = headers:get(":path")
                local host = headers:get(":authority")

                if not host then
                  return
                end

                if not path then
                  return
                end

                -- Only apply to keycloak hosts
                local is_keycloak_host = (host == "sso.{{ .Values.domain }}") or (host == "keycloak.{{ tpl .Values.adminDomain . }}")
                if not is_keycloak_host then
                  return
                end

                -- Only process OIDC logout endpoint requests
                if not string.find(path, "/protocol/openid%-connect/logout") then
                  return
                end

                -- Split the path into the portion before '?' and the raw query string
                -- 'query' is an empty string when no '?' present
                local path_only, query = string.match(path, "^([^?]*)%??(.*)$")

                -- No query string => nothing to strip
                if #query == 0 then
                  return
                end

                -- Replace post_logout_redirect_uri with uds_post_logout_redirect_uri in the query parameters
                local new_params = {}
                local logout_redirect_value = nil
                for param in string.gmatch(query, "[^&]+") do
                  local key = string.match(param, "^([^=]+)=?")
                  -- Keycloak displays a logout confirmation only when it doesn't end up with a redirect.
                  -- We remove the original "post_logout_redirect_uri" and re-add its value under
                  -- the name "uds_post_logout_redirect_uri" so that downstream apps can still read it.
                  if key == "post_logout_redirect_uri" then
                    logout_redirect_value = string.match(param, "^[^=]+=(.*)$") or ""
                  else
                    table.insert(new_params, param)
                  end
                end
                if logout_redirect_value ~= nil then
                  table.insert(new_params, "uds_post_logout_redirect_uri=" .. logout_redirect_value)
                end

                -- Rebuild the query string from kept params
                local new_query = table.concat(new_params, "&")
                local new_path = (#new_query > 0) and (path_only .. "?" .. new_query) or path_only

                -- Only rewrite when something actually changed
                if new_path ~= path then
                  headers:replace(":path", new_path)
                end
              end
{{- end }}
