kind: ZarfPackageConfig
metadata:
  name: uds-core-alloy-common
  description: "UDS Core Alloy Common"
  url: "https://grafana.com/docs/alloy/latest/"
  source: "https://github.com/grafana/alloy/tree/main/operations/helm/charts/alloy"

components:
  - name: alloy
    required: true
    charts:
      - name: uds-alloy-config
        namespace: alloy
        version: 0.1.0
        localPath: ../chart
        # Dev-values for using s3 storage
        # valuesFiles:
        #   - ../chart/dev-values.yaml
      - name: alloy
        url: https://grafana.github.io/helm-charts
        version: 0.6.1
        namespace: alloy
        valuesFiles:
          - ../values/values.yaml
    actions:
      onDeploy:
        before:
          - description: Remove Promtail Components if necessary
            mute: true
            cmd: |
              ./zarf package remove core --components promtail --confirm || true # Ensure this doesn't error on installs
              ./zarf tools kubectl delete ns promtail || true # Ensure this doesn't error on installs
        after:
          - description: Annotate Alloy daemonset with config secret
            cmd: |
              CONFIG_CHECKSUM=$(./zarf tools kubectl get configmap alloy-config -o json -n alloy | sha256sum | cut -d' ' -f1)
              ./zarf tools kubectl patch daemonset alloy -n alloy -p "{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"checksum/uds-config\":\"$CONFIG_CHECKSUM\"}}}}}"
          - description: Validate Alloy Package
            maxTotalSeconds: 300
            wait:
              cluster:
                kind: Packages
                name: alloy
                namespace: alloy
                condition: "'{.status.phase}'=Ready"
