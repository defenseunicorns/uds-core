# Copyright 2024 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

tasks:
  - name: validate
    actions:
      - description: Validate loki
        wait:
          cluster:
            kind: Pod
            name: app.kubernetes.io/name=loki
            namespace: loki
            condition: Ready
      - description: Validate uds-loki-dns
        wait:
          cluster:
            kind: Service
            name: app.kubernetes.io/component=uds-loki-dns
            namespace: kube-system
      - description: Validate loki-gw
        wait:
          cluster:
            kind: Pod
            name: app.kubernetes.io/component=gateway
            namespace: loki
            condition: Ready

  - name: e2e-k8s-tests
    actions:
      - description: "Apply Configmap and jobs for Loki e2e tests."
        cmd: |
          uds zarf package create e2e/k8s/loki --confirm
          uds zarf package deploy build/zarf-package-uds-core-e2e-loki*.zst --confirm
      - description: Loki E2E - Retention Test
        wait:
          cluster:
            kind: Job
            name: retention-test
            namespace: loki
            condition: Complete
      - description: Loki E2E - Services Running Test
        wait:
          cluster:
            kind: Job
            name: validate-loki-services-job
            namespace: loki
            condition: Complete
      - description: Loki E2E - Label Querying
        wait:
          cluster:
            kind: Job
            name: validate-label-querying-job
            namespace: loki
            condition: Complete
      - description: Loki E2E - Stored Logs
        wait:
          cluster:
            kind: Job
            name: validate-stored-log-job
            namespace: loki
            condition: Complete
      - description: Loki E2E - Vector Logs
        wait:
          cluster:
            kind: Job
            name: validate-vector-logs-job
            namespace: loki
            condition: Complete
      - description: Loki E2E - Cleanup Tests
        cmd: |
          zarf package remove build/zarf-package-uds-core-e2e-loki-*.zst --confirm
