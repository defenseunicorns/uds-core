# Copyright 2024 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

kind: ZarfPackageConfig
metadata:
  name: uds-core-velero-common
  description: "UDS Core Velero Common"
  url: https://velero.io/

variables:
  - name: VELERO_BUCKET_PROVIDER_URL
    description: "S3 compatible object storage service for use with Velero"
    default: "http://minio.uds-dev-stack.svc.cluster.local:9000"
  - name: VELERO_BUCKET
    description: "S3 compatible object storage bucket for use with Velero"
    default: "uds"
  - name: VELERO_BUCKET_REGION
    description: "Region of the bucket for use with Velero"
    default: "uds-dev-stack"
  - name: VELERO_BUCKET_KEY
    description: "Key to use when connecting to the Velero bucket"
    default: "uds"
  - name: VELERO_BUCKET_KEY_SECRET
    sensitive: true
    description: "Key secret to use when connecting to the Velero bucket"
    default: "uds-secret"
  - name: VELERO_BUCKET_CREDENTIAL_NAME
    default: "velero-bucket-credentials"
  - name: VELERO_BUCKET_CREDENTIAL_KEY
    default: "cloud"

components:
  - name: velero-crds
    required: true
    manifests:
      - name: velero-crds
        files:
          - https://raw.githubusercontent.com/vmware-tanzu/helm-charts/refs/tags/velero-11.0.0/charts/velero/crds/backuprepositories.yaml
          - https://raw.githubusercontent.com/vmware-tanzu/helm-charts/refs/tags/velero-11.0.0/charts/velero/crds/backups.yaml
          - https://raw.githubusercontent.com/vmware-tanzu/helm-charts/refs/tags/velero-11.0.0/charts/velero/crds/backupstoragelocations.yaml
          - https://raw.githubusercontent.com/vmware-tanzu/helm-charts/refs/tags/velero-11.0.0/charts/velero/crds/datadownloads.yaml
          - https://raw.githubusercontent.com/vmware-tanzu/helm-charts/refs/tags/velero-11.0.0/charts/velero/crds/datauploads.yaml
          - https://raw.githubusercontent.com/vmware-tanzu/helm-charts/refs/tags/velero-11.0.0/charts/velero/crds/deletebackuprequests.yaml
          - https://raw.githubusercontent.com/vmware-tanzu/helm-charts/refs/tags/velero-11.0.0/charts/velero/crds/downloadrequests.yaml
          - https://raw.githubusercontent.com/vmware-tanzu/helm-charts/refs/tags/velero-11.0.0/charts/velero/crds/podvolumebackups.yaml
          - https://raw.githubusercontent.com/vmware-tanzu/helm-charts/refs/tags/velero-11.0.0/charts/velero/crds/podvolumerestores.yaml
          - https://raw.githubusercontent.com/vmware-tanzu/helm-charts/refs/tags/velero-11.0.0/charts/velero/crds/restores.yaml
          - https://raw.githubusercontent.com/vmware-tanzu/helm-charts/refs/tags/velero-11.0.0/charts/velero/crds/schedules.yaml
          - https://raw.githubusercontent.com/vmware-tanzu/helm-charts/refs/tags/velero-11.0.0/charts/velero/crds/serverstatusrequests.yaml
          - https://raw.githubusercontent.com/vmware-tanzu/helm-charts/refs/tags/velero-11.0.0/charts/velero/crds/volumesnapshotlocations.yaml
    actions:
      onDeploy:
        before:
          - description: Handle Helm ownership metadata change on upgrade
            cmd: |
              RELEASE_NAME=${ZARF_CONST_VELERO_CRD_HASH_NAME:-zarf-757fff81e3625be0e18f645830e50a406dd1b0d8}
              RELEASE_NAMESPACE="default"

              for crd in \
                backuprepositories.velero.io \
                backups.velero.io \
                backupstoragelocations.velero.io \
                datadownloads.velero.io \
                datauploads.velero.io \
                deletebackuprequests.velero.io \
                downloadrequests.velero.io \
                podvolumebackups.velero.io \
                podvolumerestores.velero.io \
                restores.velero.io \
                schedules.velero.io \
                serverstatusrequests.velero.io \
                volumesnapshotlocations.velero.io; do

                kubectl label crd "$crd" app.kubernetes.io/managed-by=Helm --overwrite || true
                kubectl annotate crd "$crd" meta.helm.sh/release-name="$RELEASE_NAME" --overwrite || true
                kubectl annotate crd "$crd" meta.helm.sh/release-namespace="$RELEASE_NAMESPACE" --overwrite || true
              done

  - name: velero
    required: true
    charts:
      - name: uds-velero-config
        namespace: velero
        version: 0.1.0
        localPath: ../chart
      - name: velero
        namespace: velero
        url: https://vmware-tanzu.github.io/helm-charts
        version: 11.0.0
        repoName: velero
        releaseName: velero
        valuesFiles:
          - ../values/values.yaml
