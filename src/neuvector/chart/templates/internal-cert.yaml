{{- if .Values.generateInternalCert }}
{{- $cn := "neuvector" }}
{{- $ca := genCA "neuvector" 365 -}}
{{- $cert := genSignedCert $cn nil (list $cn) 365 $ca -}}
{{- $name := "neuvector-internal-cert" -}}
# This is a temporary workaround to a bug with the chainguard images not providing the internal certs
apiVersion: v1
kind: Secret
metadata:
  name: neuvector-internal-cert
  namespace: {{ .Release.Namespace }}
type: Opaque
data:
  tls.key: {{ include "neuvector.secrets.lookup" (dict "namespace" .Release.Namespace "secret" $name "key" "tls.key" "defaultValue" $cert.Key) }}
  tls.crt: {{ include "neuvector.secrets.lookup" (dict "namespace" .Release.Namespace "secret" $name "key" "tls.crt" "defaultValue" $cert.Cert) }}
  ca.crt: {{ include "neuvector.secrets.lookup" (dict "namespace" .Release.Namespace "secret" $name "key" "ca.crt" "defaultValue" $ca.Cert) }}
---
{{- end }}
