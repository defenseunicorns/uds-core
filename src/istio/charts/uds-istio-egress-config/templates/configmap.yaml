# Copyright 2024 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

{{- if .Values.config.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: egress-waypoint-config
  namespace: {{ .Release.Namespace }}
data:
  {{- with .Values.config.deployment }}
  deployment: |
    {{- with .podAnnotations }}
    metadata:
      annotations: 
        {{- toYaml . | nindent 8 }}
    {{- end }}
    spec:
      replicas: {{ .replicas }}
      template:
        spec:
          containers:
          - name: istio-proxy
            resources:
              requests:
                cpu: {{ .requests.cpu }}
                memory: {{ .requests.memory }}
              limits:
                cpu: {{ .limits.cpu }}
                memory: {{ .limits.memory }}
  {{- end }}
  {{- with .Values.config.service }}
  service: |
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- with .Values.config.serviceAccount }}
  serviceAccount: |
    {{-  toYaml . | nindent 4 }}
  {{- end }}
  {{- with .Values.config.horizontalPodAutoscaler }}
  horizontalPodAutoscaler: |
    spec:
      {{ with .minReplicas }}minReplicas: {{ . }}{{- end }}
      {{ with .maxReplicas }}maxReplicas: {{ . }}{{- end }}
      {{- if .metrics }}
      metrics:
        {{- toYaml .metrics | nindent 8 }}
      {{- end }}
  {{- end }}
  {{- with .Values.config.podDisruptionBudget }}
  podDisruptionBudget: |
    spec:
      selector:
        matchLabels:
          gateway.networking.k8s.io/gateway-name: egress-waypoint
      {{ with .minAvailable }}minAvailable: {{ . }}{{- end }}
      {{- if and .maxUnavailable (not .minAvailable) }}
      maxUnavailable: {{ .maxUnavailable }}
      {{- end }}
  {{- end }}
{{- end }}
