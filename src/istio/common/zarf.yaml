# Copyright 2024 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

kind: ZarfPackageConfig
metadata:
  name: uds-core-istio-common
  description: "UDS Core Istio Common"
  url: https://istio.io/latest/

components:
  - name: istio-controlplane
    required: true
    charts:
      - name: base
        url: https://istio-release.storage.googleapis.com/charts
        version: 1.23.2
        namespace: istio-system
      - name: uds-global-istio-config
        namespace: istio-system
        version: 0.1.0
        localPath: chart
      - name: istiod
        url: https://istio-release.storage.googleapis.com/charts
        version: 1.23.2
        namespace: istio-system
        valuesFiles:
          - "../values/base-istiod.yaml"
      - name: cni
        url: https://istio-release.storage.googleapis.com/charts
        version: 1.23.2
        namespace: istio-system
        valuesFiles:
          - "../values/base-cni.yaml" # values for k3s/k3d cni
      - name: ztunnel
        url: https://istio-release.storage.googleapis.com/charts
        version: 1.23.2
        namespace: istio-system
    actions:
      onDeploy:
        before:
          - description: "Fix helm ownership metadata on upgrade"
            mute: true
            cmd: |
              ./zarf tools kubectl annotate envoyfilter -n istio-system misdirected-request meta.helm.sh/release-name=uds-global-istio-config --overwrite || true
              ./zarf tools kubectl annotate envoyfilter -n istio-system remove-server-header meta.helm.sh/release-name=uds-global-istio-config --overwrite || true
              ./zarf tools kubectl annotate peerauthentication -n istio-system default-istio-system meta.helm.sh/release-name=uds-global-istio-config --overwrite || true
        after:
          - description: "Ensure istio ambient is enabled for Pepr"
            cmd: "./zarf tools kubectl label namespace pepr-system istio.io/dataplane-mode=ambient --overwrite"
          - description: "Ensure istio-injection is disabled for Pepr"
            cmd: "./zarf tools kubectl label namespace pepr-system istio-injection=disabled --overwrite"
          - description: "Cycle Pepr to refresh connections post-ambient"
            cmd: |
              ./zarf tools kubectl rollout restart -n pepr-system deploy/pepr-uds-core-watcher
              ./zarf tools kubectl rollout restart -n pepr-system deploy/pepr-uds-core
