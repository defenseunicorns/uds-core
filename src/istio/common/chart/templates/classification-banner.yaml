# Copyright 2024 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

{{- if .Values.classificationBanner.enabled }}
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: classification-banner
  namespace: istio-system
spec:
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: GATEWAY
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
            subFilter:
              name: "envoy.filters.http.router"
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.filters.http.compressor
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.http.compressor.v3.Compressor
          response_direction_config:
            common_config:
              min_content_length: 100
              content_type:
                - text/html
                - application/json
            disable_on_etag_header: true
          request_direction_config:
            common_config:
              enabled:
                default_value: false
                runtime_key: request_compressor_enabled
          compressor_library:
            name: text_optimized
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.compression.gzip.compressor.v3.Gzip
              memory_level: 3
              window_bits: 10
              compression_level: BEST_COMPRESSION
              compression_strategy: DEFAULT_STRATEGY
  - applyTo: HTTP_FILTER
    match:
      context: GATEWAY
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
            subFilter:
              name: "envoy.filters.http.router"
    patch:
      operation: INSERT_BEFORE
      value: # Lua script configuration
        name: envoy.lua
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua"
          inlineCode: |-
            local classification = "{{ .Values.classificationBanner.classification }}"
            local textColor = "{{ .Values.classificationBanner.textColor }}"
            local backgroundColor = "{{ .Values.classificationBanner.backgroundColor }}"
            local style = "background-color: " .. backgroundColor .. "; color: " .. textColor .. "; height: 16px; line-height: 16px; border: 1px solid transparent; border-radius: 0; position: fixed; left: 0; width: 100vw; text-align: center; margin: 0; z-index: 10000;"

            local header = "<div id=\"classification-banner-top\" style=\"" .. style .. " top: 0;\">" .. classification .. "</div>"
            local footer = "<div id=\"classification-banner-bottom\" style=\"" .. style .. " bottom: 0;\">" .. classification .. "</div>"

            local bodyPaddingScript = [[
            <script>
              document.addEventListener('DOMContentLoaded', function () {
                var headerBanner = document.getElementById('classification-banner-top');
                var footerBanner = document.getElementById('classification-banner-bottom');

                if (headerBanner) {
                  document.body.style.paddingTop = headerBanner.offsetHeight + 'px';
                }
                if (footerBanner) {
                  var footerHeight = footerBanner.offsetHeight;
                  document.body.style.paddingBottom = footerHeight + 'px';

                  // Check for existing footers and push them up
                  var existingFooter = document.querySelector('footer');
                  if (existingFooter) {
                    existingFooter.style.marginBottom = footerHeight + 'px';
                  }
                }
              });
            </script>
            ]]

            function envoy_on_response(response_handle)
              local content_type = response_handle:headers():get("Content-Type") or ""

              if string.find(content_type, "text/html") then
                local iterator = response_handle:bodyChunks()
                for chunk in iterator do
                  local body_size = chunk:length()
                  local body_bytes = chunk:getBytes(0, body_size)
                  local raw_text = tostring(body_bytes)

                  chunk:setBytes(header .. footer .. bodyPaddingScript .. raw_text)
                  break
                end
              end
            end
  - applyTo: HTTP_FILTER
    match:
      context: GATEWAY
      listener:
        filterChain:
          filter:
            name: "envoy.filters.network.http_connection_manager"
            subFilter:
              name: "envoy.filters.http.router"
    patch:
      operation: INSERT_BEFORE
      value: # Lua script configuration 
        name: envoy.filters.http.decompressor
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.http.decompressor.v3.Decompressor
          decompressor_library:
            name: small
            typed_config:
              "@type": "type.googleapis.com/envoy.extensions.compression.gzip.decompressor.v3.Gzip"
              chunk_size: 65536
          request_direction_config:
            common_config:
              enabled:
                default_value: false
                runtime_key: request_decompressor_enabled
{{- end }}
