# Copyright 2025 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial
{{- if .Values.clusterHealthRules.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: "{{ .Release.Name }}-uds-cluster-health"
  namespace: {{ .Release.Namespace }}
  labels:
    release:  {{ .Release.Name }}
spec:
  groups:
    - name: "{{ .Release.Name }}-uds-cluster-health.rules"
      interval: 1m
      rules:
        - record: uds_cluster_health_score
          expr: |
            (
              # 50% weight for Kubernetes API Server health
              (max by (scope_member_id) (up{job="apiserver"}) or vector(1)) * 50
              +
              # 15% weight for CoreDNS health
              (max by (scope_member_id) (up{job="coredns"}) or vector(1)) * 15
              +
              # 20% weight for Pepr health
              (max by (scope_member_id) (up{job="pepr-uds-core"}) or vector(1)) * 20
              +
              # 10% weight for Keycloak health
              (max by (scope_member_id) (up{job="keycloak-http"}) or vector(1)) * 10
              +
              # 5% weight for Grafana health
              (max by (scope_member_id) (up{job="grafana"}) or vector(1)) * 5
            )
        - alert: UDSClusterHealthScoreWarning
          expr: uds_cluster_health_score < 95
          for: 1m
          labels:
            severity: warning
            reason: "UDS cluster health score is below 95%"
          annotations:
            summary: "UDS Cluster Health Score: Warning"
            description: "The UDS cluster health score has been below 95% for more than 1 minute."
        - alert: UDSClusterHealthScoreCritical
          expr: uds_cluster_health_score < 80
          for: 1m
          labels:
            severity: critical
            reason: "UDS cluster health score is below 80%"
          annotations:
            summary: "UDS Cluster Health Score: Critical"
            description: "The UDS cluster health score has been below 80% for more than 1 minute."
{{- end -}}