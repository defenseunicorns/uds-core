# Copyright 2024 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

tasks:
  - name: validate
    actions:
      - description: "Run Pepr Validate"
  - name: gen-crds
    description: "Generate CRDs"
    actions:
      - cmd: |
          npx ts-node src/pepr/scripts/gen-crds.ts
        description: "Generate CRD YAML files"
      - cmd: |
          # renovate: datasource=github-tags depName=defenseunicorns/kubernetes-fluent-client versioning=semver
          npx kubernetes-fluent-client@3.10.14 crd src/pepr/uds-cluster-crds/templates/packages.uds.dev.yaml src/pepr/operator/crd/generated
        description: "Generate TS types for packages.uds.dev"

      - cmd: |
          # renovate: datasource=github-tags depName=defenseunicorns/kubernetes-fluent-client versioning=semver
          npx kubernetes-fluent-client@3.10.14 crd src/pepr/uds-cluster-crds/templates/packages.uds.dev.yaml -l json-schema schemas
          # Move the schema files to a standard path
          mv schemas/package-v1alpha1.json-schema schemas/package-v1alpha1.schema.json
          # Make the schema strict on additionalProperties
          uds zarf tools yq -i '(.. | select(has("additionalProperties") and .additionalProperties | select(length==0))) |= .additionalProperties = false' schemas/package-v1alpha1.schema.json
          uds zarf tools yq -i '.definitions.Package.additionalProperties = {}' schemas/package-v1alpha1.schema.json
        description: "Generate JSON schema for packages.uds.dev"

      - cmd: |
          # renovate: datasource=github-tags depName=defenseunicorns/kubernetes-fluent-client versioning=semver
          npx kubernetes-fluent-client@3.10.14 crd src/pepr/uds-cluster-crds/templates/exemptions.uds.dev.yaml src/pepr/operator/crd/generated
        description: "Generate TS types for exemptions.uds.dev"

      - cmd: |
          # renovate: datasource=github-tags depName=defenseunicorns/kubernetes-fluent-client versioning=semver
          npx kubernetes-fluent-client@3.10.14 crd src/pepr/uds-cluster-crds/templates/exemptions.uds.dev.yaml -l json-schema schemas
          # Move the schema files to a standard path
          mv schemas/exemption-v1alpha1.json-schema schemas/exemption-v1alpha1.schema.json
          # Make the schema strict on additionalProperties
          uds zarf tools yq -i '(.. | select(has("additionalProperties") and .additionalProperties | select(length==0))) |= .additionalProperties = false' schemas/exemption-v1alpha1.schema.json
          uds zarf tools yq -i '.definitions.Exemption.additionalProperties = {}' schemas/exemption-v1alpha1.schema.json
        description: "Generate JSON schema for exemptions.uds.dev"

      - cmd: |
          # renovate: datasource=github-tags depName=defenseunicorns/kubernetes-fluent-client versioning=semver
          npx kubernetes-fluent-client@3.10.14 crd src/pepr/uds-cluster-crds/templates/clusterconfig.uds.dev.yaml src/pepr/operator/crd/generated
        description: "Generate TS types for clusterconfig.uds.dev"

      - cmd: |
          # renovate: datasource=github-tags depName=defenseunicorns/kubernetes-fluent-client versioning=semver
          npx kubernetes-fluent-client@3.10.14 crd src/pepr/uds-cluster-crds/templates/clusterconfig.uds.dev.yaml -l json-schema schemas
          # Move the schema files to a standard path
          mv schemas/clusterconfig-v1alpha1.json-schema schemas/clusterconfig-v1alpha1.schema.json
          # Make the schema strict on additionalProperties
          uds zarf tools yq -i '(.. | select(has("additionalProperties") and .additionalProperties | select(length==0))) |= .additionalProperties = false' schemas/clusterconfig-v1alpha1.schema.json
          uds zarf tools yq -i '.definitions.ClusterConfig.additionalProperties = {}' schemas/clusterconfig-v1alpha1.schema.json
        description: "Generate JSON schema for clusterconfig.uds.dev"

      - task: gen-manifests

      - description: "Add license headers to generated CRD files"
        shell:
          darwin: bash
          linux: bash
        cmd: |
          # check for addlicense bin
          if [ -x "$HOME/go/bin/addlicense" ]; then
            echo "addlicense installed in $HOME/go/bin"
          else
            echo "Error: addlicense is not installed in $HOME/go/bin" >&2
            exit 1
          fi
          $HOME/go/bin/addlicense -l "AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial" -s=only -v -c "Defense Unicorns" src/pepr/operator/crd/generated
          $HOME/go/bin/addlicense -l "AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial" -s=only -v -c "Defense Unicorns" src/pepr/uds-cluster-crds/templates
          $HOME/go/bin/addlicense -l "AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial" -s=only -v -c "Defense Unicorns" src/pepr/uds-cluster-crds/templates

      - task: gen-docs

      - cmd: "npx pepr format"

  - name: gen-manifests
    description: "Generate CRD manifests"
    actions:
      - cmd: |
          CRD_LIST="clusterconfig.uds.dev"
          for CRD in $CRD_LIST; do
             FILE="src/pepr/uds-cluster-crds/templates/$CRD.yaml"
             uds zarf tools kubectl get crd $CRD -o yaml > $FILE
             uds zarf tools yq -i 'del(.metadata.creationTimestamp,.metadata.generation,.metadata.resourceVersion,.metadata.uid,.status,.metadata.labels,.metadata.annotations)' $FILE
          done

  - name: gen-docs
    description: "Generate Docs for generated CRDs"
    actions:
      - description: "Generate Docs for CRDs"
        cmd: |
          CRD_LIST="exemptions.uds.dev packages.uds.dev clusterconfig.uds.dev"
          for CRD in $CRD_LIST; do
              # Convert YAML to JSON and extract openAPIV3Schema for v1alpha1
              yq -o=json '.spec.versions[] | select(.name == "v1alpha1").schema.openAPIV3Schema' src/pepr/uds-cluster-crds/templates/$CRD.yaml > $CRD-crd.json
              # Set version manually (since you know it's v1alpha1)
              version="v1alpha1"
              # Typescript format markdown
              npx ts-node --project src/pepr/tsconfig-docs-gen.json src/pepr/docs-gen/main.ts "$CRD-crd.json" "$version"
              # Remove the json file
              rm -f "$CRD-crd.json"
          done

  - name: e2e-test
    actions:
      - description: "Run Pepr E2E tests"
