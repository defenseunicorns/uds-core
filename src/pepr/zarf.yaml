# Copyright 2024 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

kind: ZarfPackageConfig
metadata:
  name: pepr-uds-core
  description: "Pepr Module: A collection of capabilities for UDS Core"
  url: https://github.com/defenseunicorns/pepr

variables:
  - name: DOMAIN
    description: "Cluster domain"
    default: "uds.dev"

  - name: ADMIN_DOMAIN
    description: "Domain for admin services, defaults to `admin.DOMAIN`"

  # Note: This variable is deprecated and will be removed in future releases. Please use CA_BUNDLE_CERTS instead.
  - name: CA_CERT
    description: "Base64 encoded CA cert that signed the domain wildcard certs used for Istio ingress"
    default: ""

  - name: CA_BUNDLE_CERTS
    description: "Base64 encoded CA certs (bundle) in PEM format that UDS Core will inherently trust. At a minimum this must at least include your Domain CA Cert if using Private PKI for your UDS Core Deployment"
    default: ""

  - name: CA_BUNDLE_INCLUDE_DOD_CERTS
    description: "Whether to include DoD root and intermediate certificates in the cluster CA bundle"
    default: false

  - name: CA_BUNDLE_INCLUDE_PUBLIC_CERTS
    description: "Whether to include public root and intermediate certificates in the cluster CA bundle"
    default: false

  - name: UDS_LOG_LEVEL
    description: "UDS Operator log level"
    default: "debug"

  - name: AUTHSERVICE_REDIS_URI
    description: "UDS Authservice Redis URI"
    default: ""

  - name: PEPR_SERVICE_MONITORS
    description: "Enables Service Monitors for Pepr services (watcher, admission)"
    default: "true"

  - name: ALLOW_ALL_NS_EXEMPTIONS
    description: "Whether to allow exemptions to be created in all namespaces"
    default: "false"

components:
  - name: uds-crds
    required: true
    charts:
      - name: uds-cluster-crds
        namespace: pepr-system
        version: 0.1.0
        localPath: uds-cluster-crds

  - name: uds-crds-v2
    required: true
    charts:
      - name: uds-cluster-crds-v2
        namespace: pepr-system
        version: 0.1.0
        localPath: uds-cluster-crds-v2
    actions:
      onDeploy:
        after:
          - description: Validate ClusterConfig CRD
            maxTotalSeconds: 60
            wait:
              cluster:
                kind: CustomResourceDefinition
                name: clusterconfig.uds.dev

  - name: uds-operator-config
    required: true
    charts:
      - name: uds-operator-config
        namespace: pepr-system
        version: 0.1.0
        localPath: uds-operator-config
        valuesFiles:
          - uds-operator-config/values.yaml
    actions:
      onDeploy:
        after:
          - description: "Ensure Istio Ambient is enabled for Pepr"
            cmd: |
              echo "Setting Ambient mode for pepr-system..."
              ./zarf tools kubectl label namespace pepr-system "istio.io/dataplane-mode"="ambient" --overwrite

              echo "Disabling istio-injection on pepr-system..."
              ./zarf tools kubectl label namespace pepr-system istio-injection=disabled --overwrite

  - name: pepr-uds-core
    required: true
    import:
      name: module
      path: ../../dist
    charts:
      - name: module
        valuesFiles:
          - values.yaml
    actions:
      onDeploy:
        after:
          - description: Validate ClusterConfig
            maxTotalSeconds: 60
            wait:
              cluster:
                kind: ClusterConfig
                name: uds-cluster-config
                condition: "'{.status.phase}'=Ready"

  - name: uds-exemptions
    required: true
    charts:
      - name: uds-exemptions
        namespace: uds-policy-exemptions
        version: 0.1.0
        localPath: uds-exemptions
        valuesFiles:
          - uds-exemptions/values.yaml
