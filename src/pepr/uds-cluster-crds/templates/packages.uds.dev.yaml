# Copyright 2025 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: packages.uds.dev
spec:
  conversion:
    strategy: None
  group: uds.dev
  names:
    kind: Package
    listKind: PackageList
    plural: packages
    shortNames:
      - pkg
    singular: package
  scope: Namespaced
  versions:
    - additionalPrinterColumns:
        - description: The status of the package
          jsonPath: .status.phase
          name: Status
          type: string
        - description: SSO Clients created by the package
          jsonPath: .status.ssoClients
          name: SSO Clients
          type: string
        - description: Service endpoints exposed by the package
          jsonPath: .status.endpoints
          name: Endpoints
          type: string
        - description: Service monitors for the package
          jsonPath: .status.monitors
          name: Monitors
          type: string
        - description: The number of network policies created by the package
          jsonPath: .status.networkPolicyCount
          name: Network Policies
          type: integer
        - description: The age of the package
          jsonPath: .metadata.creationTimestamp
          name: Age
          type: date
      name: v1alpha1
      schema:
        openAPIV3Schema:
          properties:
            spec:
              properties:
                monitor:
                  description: Create Service or Pod Monitor configurations
                  items:
                    properties:
                      authorization:
                        description: Authorization settings.
                        properties:
                          credentials:
                            description: Selects a key of a Secret in the namespace that contains the credentials for authentication.
                            properties:
                              key:
                                description: The key of the secret to select from. Must be a valid secret key.
                                type: string
                              name:
                                description: 'Name of the referent. More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names'
                                type: string
                              optional:
                                description: Specify whether the Secret or its key must be defined
                                type: boolean
                            required:
                              - key
                            type: object
                          type:
                            description: 'Defines the authentication type. The value is case-insensitive. "Basic" is not a supported value. Default: "Bearer"'
                            type: string
                        required:
                          - credentials
                        type: object
                      description:
                        description: A description of this monitor entry, this will become part of the ServiceMonitor name
                        type: string
                      fallbackScrapeProtocol:
                        description: The protocol for Prometheus to use if a scrape returns a blank, unparsable, or otherwise invalid Content-Type
                        enum:
                          - OpenMetricsText0.0.1
                          - OpenMetricsText1.0.0
                          - PrometheusProto
                          - PrometheusText0.0.4
                          - PrometheusText1.0.0
                        type: string
                      kind:
                        description: The type of monitor to create; PodMonitor or ServiceMonitor. ServiceMonitor is the default.
                        enum:
                          - PodMonitor
                          - ServiceMonitor
                        type: string
                      path:
                        description: HTTP path from which to scrape for metrics, defaults to `/metrics`
                        type: string
                      podSelector:
                        additionalProperties:
                          type: string
                        description: Labels to match pods in the namespace to apply the policy to. Leave empty to apply to all pods in the namespace
                        type: object
                      portName:
                        description: The port name for the serviceMonitor
                        type: string
                      selector:
                        additionalProperties:
                          type: string
                        description: Labels to match pods in the namespace to apply the policy to. Leave empty to apply to all pods in the namespace
                        type: object
                      targetPort:
                        description: The service targetPort. This is required so the NetworkPolicy can be generated correctly.
                        maximum: 65535
                        minimum: 1
                        type: number
                    required:
                      - portName
                      - selector
                      - targetPort
                    type: object
                  type: array
                network:
                  description: Network configuration for the package
                  properties:
                    allow:
                      description: Allow specific traffic (namespace will have a default-deny policy)
                      items:
                        properties:
                          description:
                            description: A description of the policy, this will become part of the policy name
                            type: string
                          direction:
                            description: The direction of the traffic
                            enum:
                              - Ingress
                              - Egress
                            type: string
                          labels:
                            additionalProperties:
                              type: string
                            description: The labels to apply to the policy
                            type: object
                          podLabels:
                            additionalProperties:
                              type: string
                            description: 'Deprecated: use selector'
                            type: object
                          port:
                            description: The port to allow (protocol is always TCP)
                            maximum: 65535
                            minimum: 1
                            type: number
                          ports:
                            description: A list of ports to allow (protocol is always TCP)
                            items:
                              maximum: 65535
                              minimum: 1
                              type: number
                            type: array
                          remoteCidr:
                            description: Custom generated policy CIDR
                            type: string
                          remoteGenerated:
                            description: Custom generated remote selector for the policy
                            enum:
                              - KubeAPI
                              - KubeNodes
                              - IntraNamespace
                              - CloudMetadata
                              - Anywhere
                            type: string
                          remoteNamespace:
                            description: The remote namespace to allow traffic to/from. Use * or empty string to allow all namespaces
                            type: string
                          remotePodLabels:
                            additionalProperties:
                              type: string
                            description: 'Deprecated: use remoteSelector'
                            type: object
                          remoteSelector:
                            additionalProperties:
                              type: string
                            description: The remote pod selector labels to allow traffic to/from
                            type: object
                          selector:
                            additionalProperties:
                              type: string
                            description: Labels to match pods in the namespace to apply the policy to. Leave empty to apply to all pods in the namespace
                            type: object
                        required:
                          - direction
                        type: object
                      type: array
                    expose:
                      description: Expose a service on an Istio Gateway
                      items:
                        anyOf:
                          - required:
                              - service
                              - podLabels
                              - port
                          - required:
                              - service
                              - selector
                              - port
                          - required:
                              - advancedHTTP
                        properties:
                          advancedHTTP:
                            description: Advanced HTTP settings for the route.
                            properties:
                              corsPolicy:
                                description: Cross-Origin Resource Sharing policy (CORS).
                                properties:
                                  allowCredentials:
                                    description: Indicates whether the caller is allowed to send the actual request (not the preflight) using credentials.
                                    nullable: true
                                    type: boolean
                                  allowHeaders:
                                    description: List of HTTP headers that can be used when requesting the resource.
                                    items:
                                      type: string
                                    type: array
                                  allowMethods:
                                    description: List of HTTP methods allowed to access the resource.
                                    items:
                                      type: string
                                    type: array
                                  allowOrigin:
                                    items:
                                      type: string
                                    type: array
                                  allowOrigins:
                                    description: String patterns that match allowed origins.
                                    items:
                                      oneOf:
                                        - not:
                                            anyOf:
                                              - required:
                                                  - exact
                                              - required:
                                                  - prefix
                                              - required:
                                                  - regex
                                        - required:
                                            - exact
                                        - required:
                                            - prefix
                                        - required:
                                            - regex
                                      properties:
                                        exact:
                                          type: string
                                        prefix:
                                          type: string
                                        regex:
                                          description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).
                                          type: string
                                      type: object
                                    type: array
                                  exposeHeaders:
                                    description: A list of HTTP headers that the browsers are allowed to access.
                                    items:
                                      type: string
                                    type: array
                                  maxAge:
                                    description: Specifies how long the results of a preflight request can be cached.
                                    type: string
                                type: object
                              directResponse:
                                description: A HTTP rule can either return a direct_response, redirect or forward (default) traffic.
                                properties:
                                  body:
                                    description: Specifies the content of the response body.
                                    oneOf:
                                      - not:
                                          anyOf:
                                            - required:
                                                - string
                                            - required:
                                                - bytes
                                      - required:
                                          - string
                                      - required:
                                          - bytes
                                    properties:
                                      bytes:
                                        description: response body as base64 encoded bytes.
                                        format: binary
                                        type: string
                                      string:
                                        type: string
                                    type: object
                                  status:
                                    description: Specifies the HTTP response status to be returned.
                                    type: integer
                                required:
                                  - status
                                type: object
                              headers:
                                properties:
                                  request:
                                    properties:
                                      add:
                                        additionalProperties:
                                          type: string
                                        type: object
                                      remove:
                                        items:
                                          type: string
                                        type: array
                                      set:
                                        additionalProperties:
                                          type: string
                                        type: object
                                    type: object
                                  response:
                                    properties:
                                      add:
                                        additionalProperties:
                                          type: string
                                        type: object
                                      remove:
                                        items:
                                          type: string
                                        type: array
                                      set:
                                        additionalProperties:
                                          type: string
                                        type: object
                                    type: object
                                type: object
                              match:
                                description: Match the incoming request based on custom rules. Not permitted when using the passthrough gateway.
                                items:
                                  properties:
                                    ignoreUriCase:
                                      description: Flag to specify whether the URI matching should be case-insensitive.
                                      type: boolean
                                    method:
                                      oneOf:
                                        - not:
                                            anyOf:
                                              - required:
                                                  - exact
                                              - required:
                                                  - prefix
                                              - required:
                                                  - regex
                                        - required:
                                            - exact
                                        - required:
                                            - prefix
                                        - required:
                                            - regex
                                      properties:
                                        exact:
                                          type: string
                                        prefix:
                                          type: string
                                        regex:
                                          description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).
                                          type: string
                                      type: object
                                    name:
                                      description: The name assigned to a match.
                                      type: string
                                    queryParams:
                                      additionalProperties:
                                        oneOf:
                                          - not:
                                              anyOf:
                                                - required:
                                                    - exact
                                                - required:
                                                    - prefix
                                                - required:
                                                    - regex
                                          - required:
                                              - exact
                                          - required:
                                              - prefix
                                          - required:
                                              - regex
                                        properties:
                                          exact:
                                            type: string
                                          prefix:
                                            type: string
                                          regex:
                                            description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).
                                            type: string
                                        type: object
                                      description: Query parameters for matching.
                                      type: object
                                    uri:
                                      oneOf:
                                        - not:
                                            anyOf:
                                              - required:
                                                  - exact
                                              - required:
                                                  - prefix
                                              - required:
                                                  - regex
                                        - required:
                                            - exact
                                        - required:
                                            - prefix
                                        - required:
                                            - regex
                                      properties:
                                        exact:
                                          type: string
                                        prefix:
                                          type: string
                                        regex:
                                          description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).
                                          type: string
                                      type: object
                                  required:
                                    - name
                                  type: object
                                type: array
                              redirect:
                                description: A HTTP rule can either return a direct_response, redirect or forward (default) traffic.
                                oneOf:
                                  - not:
                                      anyOf:
                                        - required:
                                            - port
                                        - required:
                                            - derivePort
                                  - required:
                                      - port
                                  - required:
                                      - derivePort
                                properties:
                                  authority:
                                    description: On a redirect, overwrite the Authority/Host portion of the URL with this value.
                                    type: string
                                  derivePort:
                                    description: |-
                                      On a redirect, dynamically set the port: * FROM_PROTOCOL_DEFAULT: automatically set to 80 for HTTP and 443 for HTTPS.

                                      Valid Options: FROM_PROTOCOL_DEFAULT, FROM_REQUEST_PORT
                                    enum:
                                      - FROM_PROTOCOL_DEFAULT
                                      - FROM_REQUEST_PORT
                                    type: string
                                  port:
                                    description: On a redirect, overwrite the port portion of the URL with this value.
                                    maximum: 4294967295
                                    minimum: 0
                                    type: integer
                                  redirectCode:
                                    description: On a redirect, Specifies the HTTP status code to use in the redirect response.
                                    maximum: 4294967295
                                    minimum: 0
                                    type: integer
                                  scheme:
                                    description: On a redirect, overwrite the scheme portion of the URL with this value.
                                    type: string
                                  uri:
                                    description: On a redirect, overwrite the Path portion of the URL with this value.
                                    type: string
                                type: object
                              retries:
                                description: Retry policy for HTTP requests.
                                properties:
                                  attempts:
                                    description: Number of retries to be allowed for a given request.
                                    format: int32
                                    type: integer
                                  perTryTimeout:
                                    description: Timeout per attempt for a given request, including the initial call and any retries.
                                    type: string
                                  retryOn:
                                    description: Specifies the conditions under which retry takes place.
                                    type: string
                                  retryRemoteLocalities:
                                    description: Flag to specify whether the retries should retry to other localities.
                                    nullable: true
                                    type: boolean
                                type: object
                              rewrite:
                                description: Rewrite HTTP URIs and Authority headers.
                                properties:
                                  authority:
                                    description: rewrite the Authority/Host header with this value.
                                    type: string
                                  uri:
                                    description: rewrite the path (or the prefix) portion of the URI with this value.
                                    type: string
                                  uriRegexRewrite:
                                    description: rewrite the path portion of the URI with the specified regex.
                                    properties:
                                      match:
                                        description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).
                                        type: string
                                      rewrite:
                                        description: The string that should replace into matching portions of original URI.
                                        type: string
                                    type: object
                                type: object
                              timeout:
                                description: Timeout for HTTP requests, default is disabled.
                                type: string
                              weight:
                                description: Weight specifies the relative proportion of traffic to be forwarded to the destination.
                                format: int32
                                type: integer
                            type: object
                          description:
                            description: A description of this expose entry, this will become part of the VirtualService name
                            type: string
                          gateway:
                            default: tenant
                            description: 'The name of the gateway to expose the service on (default: tenant)'
                            enum:
                              - admin
                              - tenant
                              - passthrough
                            type: string
                          host:
                            description: The hostname to expose the service on
                            type: string
                          match:
                            description: Match the incoming request based on custom rules. Not permitted when using the passthrough gateway.
                            items:
                              properties:
                                ignoreUriCase:
                                  description: Flag to specify whether the URI matching should be case-insensitive.
                                  type: boolean
                                method:
                                  oneOf:
                                    - not:
                                        anyOf:
                                          - required:
                                              - exact
                                          - required:
                                              - prefix
                                          - required:
                                              - regex
                                    - required:
                                        - exact
                                    - required:
                                        - prefix
                                    - required:
                                        - regex
                                  properties:
                                    exact:
                                      type: string
                                    prefix:
                                      type: string
                                    regex:
                                      description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).
                                      type: string
                                  type: object
                                name:
                                  description: The name assigned to a match.
                                  type: string
                                queryParams:
                                  additionalProperties:
                                    oneOf:
                                      - not:
                                          anyOf:
                                            - required:
                                                - exact
                                            - required:
                                                - prefix
                                            - required:
                                                - regex
                                      - required:
                                          - exact
                                      - required:
                                          - prefix
                                      - required:
                                          - regex
                                    properties:
                                      exact:
                                        type: string
                                      prefix:
                                        type: string
                                      regex:
                                        description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).
                                        type: string
                                    type: object
                                  description: Query parameters for matching.
                                  type: object
                                uri:
                                  oneOf:
                                    - not:
                                        anyOf:
                                          - required:
                                              - exact
                                          - required:
                                              - prefix
                                          - required:
                                              - regex
                                    - required:
                                        - exact
                                    - required:
                                        - prefix
                                    - required:
                                        - regex
                                  properties:
                                    exact:
                                      type: string
                                    prefix:
                                      type: string
                                    regex:
                                      description: RE2 style regex-based match (https://github.com/google/re2/wiki/Syntax).
                                      type: string
                                  type: object
                              required:
                                - name
                              type: object
                            type: array
                          podLabels:
                            additionalProperties:
                              type: string
                            description: 'Deprecated: use selector'
                            type: object
                          port:
                            description: The port number to expose
                            maximum: 65535
                            minimum: 1
                            type: number
                          selector:
                            additionalProperties:
                              type: string
                            description: Labels to match pods in the namespace to apply the policy to. Leave empty to apply to all pods in the namespace
                            type: object
                          service:
                            description: The name of the service to expose
                            type: string
                          targetPort:
                            description: The service targetPort. This defaults to port and is only required if the service port is different from the target port (so the NetworkPolicy can be generated correctly).
                            maximum: 65535
                            minimum: 1
                            type: number
                        required:
                          - host
                        type: object
                      type: array
                  type: object
                sso:
                  description: Create SSO client configurations
                  items:
                    properties:
                      alwaysDisplayInConsole:
                        default: false
                        description: Always list this client in the Account UI, even if the user does not have an active session.
                        type: boolean
                      attributes:
                        additionalProperties:
                          type: string
                        description: Specifies attributes for the client.
                        type: object
                      baseUrl:
                        description: Default URL to use when the auth server needs to redirect or link back to the client.
                        type: string
                      clientAuthenticatorType:
                        description: The client authenticator type
                        enum:
                          - client-secret
                          - client-jwt
                        type: string
                      clientId:
                        description: The client identifier registered with the identity provider.
                        type: string
                      defaultClientScopes:
                        description: Default client scopes
                        items:
                          type: string
                        type: array
                      description:
                        description: A description for the client, can be a URL to an image to replace the login logo
                        type: string
                      enableAuthserviceSelector:
                        additionalProperties:
                          type: string
                        description: Labels to match pods to automatically protect with authservice. Leave empty to disable authservice protection
                        type: object
                      enabled:
                        default: true
                        description: Whether the SSO client is enabled
                        type: boolean
                      groups:
                        description: The client SSO group type
                        properties:
                          anyOf:
                            description: List of groups allowed to access the client
                            items:
                              type: string
                            type: array
                        type: object
                      name:
                        description: Specifies display name of the client
                        type: string
                      protocol:
                        description: Specifies the protocol of the client, either 'openid-connect' or 'saml'
                        enum:
                          - openid-connect
                          - saml
                        type: string
                      protocolMappers:
                        default: []
                        description: Protocol Mappers to configure on the client
                        items:
                          properties:
                            config:
                              additionalProperties:
                                type: string
                              description: Configuration options for the mapper.
                              type: object
                            consentRequired:
                              default: false
                              description: Whether user consent is required for this mapper
                              type: boolean
                            name:
                              description: Name of the mapper
                              type: string
                            protocol:
                              description: Protocol of the mapper
                              enum:
                                - openid-connect
                                - saml
                              type: string
                            protocolMapper:
                              description: Protocol Mapper type of the mapper
                              type: string
                          required:
                            - name
                            - protocol
                            - protocolMapper
                          type: object
                        type: array
                      publicClient:
                        default: false
                        description: Defines whether the client requires a client secret for authentication
                        type: boolean
                      redirectUris:
                        description: Valid URI pattern a browser can redirect to after a successful login. Simple wildcards are allowed such as 'https://unicorns.uds.dev/*'
                        items:
                          type: string
                        minItems: 1
                        type: array
                      rootUrl:
                        description: Root URL appended to relative URLs
                        type: string
                      secret:
                        description: The client secret. Typically left blank and auto-generated.
                        type: string
                      secretName:
                        description: The name of the secret to store the client secret
                        type: string
                      secretTemplate:
                        additionalProperties:
                          type: string
                        description: A template for the generated secret
                        type: object
                      serviceAccountsEnabled:
                        default: false
                        description: Enables the client credentials grant based authentication via OpenID Connect protocol.
                        type: boolean
                      standardFlowEnabled:
                        default: true
                        description: Enables the standard OpenID Connect redirect based authentication with authorization code.
                        type: boolean
                      webOrigins:
                        description: Allowed CORS origins. To permit all origins of Valid Redirect URIs, add '+'. This does not include the '*' wildcard though. To permit all origins, explicitly add '*'.
                        items:
                          type: string
                        type: array
                    required:
                      - clientId
                      - name
                    type: object
                  type: array
              type: object
            status:
              properties:
                authserviceClients:
                  items:
                    type: string
                  type: array
                endpoints:
                  items:
                    type: string
                  type: array
                monitors:
                  items:
                    type: string
                  type: array
                networkPolicyCount:
                  type: integer
                observedGeneration:
                  type: integer
                phase:
                  enum:
                    - Pending
                    - Ready
                    - Failed
                    - Retrying
                    - Removing
                  type: string
                retryAttempt:
                  nullable: true
                  type: integer
                ssoClients:
                  items:
                    type: string
                  type: array
              type: object
          type: object
      served: true
      storage: true
      subresources:
        status: {}
