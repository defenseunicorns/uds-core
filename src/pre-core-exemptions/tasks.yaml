# works in conjunction with .github/bundles/exemption/uds-bundle.yaml
variables:
  - name: PODINFO_NAME

tasks:
  - name: validate
    actions:
      - description: Validate exemptions are applied
        wait:
          cluster:
            kind: exemption
            name: pre-core-exemptions
            namespace: uds-policy-exemptions
            condition: exists
      - description: Create Podinfo Zarf Pkg
        cmd: uds zarf package create src/pre-core-exemptions/test --confirm --no-progress
      - description: Deploy Podinfo Zarf Pkg
        cmd: uds zarf package deploy build/zarf-package-podinfo-*.tar.zst --confirm --no-progress
      - cmd: uds zarf tools kubectl get pods -n podinfo -o=jsonpath='{.items[0].metadata.name}'
        setVariables:
          - name: PODINFO_NAME
      - description: Check for podinfo to come back up
        wait:
          cluster:
            kind: Pod
            name: $PODINFO_NAME
            namespace: podinfo
