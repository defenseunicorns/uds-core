# Copyright 2025 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

tasks:
  - name: validate
    actions:
      - description: Validate Falcosidekick Deployment
        wait:
          cluster:
            kind: Deployment
            name: falco-falcosidekick
            condition: Available
            namespace: falco
      - description: Validate Falco Pod
        wait:
          cluster:
            kind: Pod
            name: app.kubernetes.io/name=falco
            condition: Ready
            namespace: falco

  - name: e2e-test
    inputs:
      validate_extra_rules:
        description: Whether to validate extra rules
        default: "true"

    actions:
      - description: "Run Falco E2E tests"
        cmd: |
          npm ci && EXTRA_RULES=${{ .inputs.validate_extra_rules }} npx vitest run "falco" --exclude "**/*integration*"
        dir: test/vitest

  - name: update-rules
    description: "Update Falco Incubating and Sandbox rules from upstream repository"
    actions:
      - description: "Download latest Falco rules"
        timeout: 60s
        dir: src/falco
        cmd: |
          set -e
          RULES_DIR="chart/rules"

          echo "Downloading latest Falco rules..."
          if ! curl -sSfL --connect-timeout 30 --max-time 60 \
               https://raw.githubusercontent.com/falcosecurity/rules/main/rules/falco-sandbox_rules.yaml \
               -o "${RULES_DIR}/sandbox-rules.yaml"; then
            echo "Error: Failed to download sandbox rules"
            exit 1
          fi

          if ! curl -sSfL --connect-timeout 30 --max-time 60 \
               https://raw.githubusercontent.com/falcosecurity/rules/main/rules/falco-incubating_rules.yaml \
               -o "${RULES_DIR}/incubating-rules.yaml"; then
            echo "Error: Failed to download incubating rules"
            exit 1
          fi
