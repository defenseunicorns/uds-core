# Copyright 2025 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

apiVersion: v1
kind: ConfigMap
metadata:
  name: falco-stable-rules
  namespace: falco
  labels:
    uds.dev/pod-reload: "true"
data:
  stable-rules.yaml: |-
{{ .Files.Get "rules/stable-rules.yaml" | nindent 4 }}

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: falco-incubating-rules
  namespace: falco
  labels:
    uds.dev/pod-reload: "true"
data:
  incubating-rules.yaml: |-
{{- if .Values.incubatingRulesEnabled }}
{{ .Files.Get "rules/incubating-rules.yaml" | nindent 4 }}
{{- else }}
    # Incubating rules are disabled by default
    - required_engine_version: 0
{{- end }}

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: falco-sandbox-rules
  namespace: falco
  labels:
    uds.dev/pod-reload: "true"
data:
  sandbox-rules.yaml: |-
{{- if .Values.sandboxRulesEnabled }}
{{ .Files.Get "rules/sandbox-rules.yaml" | nindent 4 }}
{{- else }}
    # Sandbox rules are disabled by default
    - required_engine_version: 0
{{- end }}

# If disabledRules or category-specific udsDefaultDisabledRules are passed in, generate a disable-rules file
{{- $allDisabledRules := list }}
{{- $allDisabledRules = concat $allDisabledRules .Values.udsDefaultDisabledRulesStable }}
{{- if .Values.incubatingRulesEnabled }}
  {{- $allDisabledRules = concat $allDisabledRules .Values.udsDefaultDisabledRulesIncubating }}
{{- end }}
{{- if .Values.sandboxRulesEnabled }}
  {{- $allDisabledRules = concat $allDisabledRules .Values.udsDefaultDisabledRulesSandbox }}
{{- end }}
{{- $allDisabledRules = concat $allDisabledRules .Values.disabledRules | uniq }}
{{- if (gt (len $allDisabledRules) 0) }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: falco-disable-rules
  namespace: falco
  labels:
    uds.dev/pod-reload: "true"
data:
  disable-rules.yaml: |-
{{- range $allDisabledRules }}
    - rule: "{{ . }}"
      enabled: false
      override:
        enabled: replace
{{- end }}
{{- end }}
