variables:
  - name: REGISTRY1_TEST_IMAGE
    default: registry1.dso.mil/ironbank/opensource/defenseunicorns/zarf/zarf-agent

tasks:
  - name: create-k3d-cluster
    actions:
      - description: "Create the K3d cluster"
        # renovate: datasource=github-tags depName=defenseunicorns/uds-k3d versioning=semver
        cmd: "uds zarf package deploy oci://defenseunicorns/uds-k3d:0.3.1 --confirm"

  - name: k3d-test-cluster
    actions:
      - task: create-k3d-cluster

      - description: "Initialize the cluster with Zarf"
        # renovate: datasource=github-tags depName=defenseunicorns/init versioning=semver
        cmd: "uds zarf package deploy oci://defenseunicorns/init:v0.32.1 --confirm"

  - name: registry-login
    inputs:
      registry:
        default: registry1.dso.mil
      registry-username:
      registry-password:
      registry-retry-interval:
        default: 5
    actions:
      - cmd: |
          echo "$INPUT_REGISTRY_PASSWORD" | uds zarf tools registry login \
            --username "${INPUT_REGISTRY_USERNAME}" \
            --password-stdin \
            "${INPUT_REGISTRY}" \
            >/dev/null

          if [ "$INPUT_REGISTRY" = "registry1.dso.mil" ]; then
             uds zarf tools registry digest \
               ${REGISTRY1_TEST_IMAGE} \
               >/dev/null || (sleep "${INPUT_REGISTRY_RETRY_INTERVAL}"; exit 1)
          fi
        maxRetries: 10
