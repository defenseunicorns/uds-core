# Copyright 2024 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

includes:
  - utils: utils.yaml

variables:
  - name: VERSION
    description: "The version of the packages to deploy"
    # x-release-please-start-version
    default: "0.61.1"
    # x-release-please-end
  - name: FLAVOR
    default: upstream

tasks:
  - name: k3d-standard-bundle
    inputs:
      K3D_EXTRA_ARGS:
        default: ""
        description: "Extra args for k3d"
    actions:
      - description: "Deploy the UDS Core Standard Bundle"
        cmd: uds deploy bundles/k3d-standard/uds-bundle-k3d-core-demo-${UDS_ARCH}-${VERSION}.tar.zst --set INSECURE_ADMIN_PASSWORD_GENERATION=true --set FALCO_SANDBOX_RULES_ENABLED=true --set FALCO_INCUBATING_RULES_ENABLED=true --set K3D_EXTRA_ARGS="${{ .inputs.K3D_EXTRA_ARGS }}" --confirm --no-progress

  - name: k3d-standard-bundle-ha
    actions:
      - description: "Deploy the UDS Core Standard Bundle"
        cmd: uds deploy bundles/k3d-standard/uds-bundle-k3d-core-demo-${UDS_ARCH}-${VERSION}.tar.zst --confirm --no-progress
        env:
          - UDS_CONFIG=bundles/k3d-standard/uds-ha-config.yaml

  - name: k3d-standard-bundle-private-pki
    actions:
      - description: "Deploy k3d cluster and init packages"
        cmd: uds deploy bundles/k3d-standard/uds-bundle-k3d-core-demo-${UDS_ARCH}-${VERSION}.tar.zst --packages uds-k3d-dev,init --confirm --no-progress

      - description: "Deploy UDS Core with Private PKI configuration"
        cmd: uds deploy bundles/k3d-standard/uds-bundle-k3d-core-demo-${UDS_ARCH}-${VERSION}.tar.zst --packages core --confirm --no-progress
        env:
          - UDS_CONFIG=build/private-pki/uds-private-pki-config.yaml

  - name: k3d-slim-dev-bundle
    actions:
      - description: "Deploy the UDS Core Slim Dev Only Bundle"
        cmd: uds deploy bundles/k3d-slim-dev/uds-bundle-k3d-core-slim-dev-${UDS_ARCH}-${VERSION}.tar.zst --confirm --no-progress

  - name: k3d-slim-dev-bundle-ha
    actions:
      - description: "Deploy the UDS Core Slim Dev Bundle with HA configuration"
        cmd: uds deploy bundles/k3d-slim-dev/uds-bundle-k3d-core-slim-dev-${UDS_ARCH}-${VERSION}.tar.zst --confirm --no-progress
        env:
          - UDS_CONFIG=bundles/k3d-slim-dev/uds-ha-config.yaml

  # This task is a wrapper to support --set LAYER=identity-authorization
  - name: single-layer-callable
    actions:
      - task: single-layer
        with:
          layer: $LAYER

  - name: single-layer
    description: "Deploy a single UDS Core layer, must set UDS_LAYER environment variable"
    inputs:
      layer:
        default: base
        description: The UDS Core layer to deploy
    actions:
      - description: "Deploy UDS Core Base Layer"
        if: ${{ eq .inputs.layer "base"}}
        cmd: uds deploy bundles/base-shim/uds-bundle-base-shim-${UDS_ARCH}-${VERSION}.tar.zst --confirm --no-progress
      - description: "Deploy a single UDS Core Layer (must set UDS_LAYER environment variable)"
        if: ${{ ne .inputs.layer "base"}}
        cmd: uds zarf package deploy build/zarf-package-core-${{ index .inputs "layer" }}-${UDS_ARCH}-${VERSION}.tar.zst --confirm --components '*'

  - name: resolve-latest-core-release
    actions:
      - task: utils:determine-repo
      - description: "Get latest tag version from OCI (conditionally pinned to specific minor stream)"
        shell:
          darwin: bash
          linux: bash
        cmd: |
          BRANCH="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME:-$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")}}"

          TARGET_VERSION=""
          if [[ "$BRANCH" == release-please--branches--release/* ]]; then
            TARGET_VERSION="${BRANCH#release-please--branches--release/}"
          fi

          if [ -n "${TARGET_VERSION}" ]; then
            uds zarf tools registry ls ${TARGET_REPO}/core | grep "${FLAVOR}" | grep -E "^${TARGET_VERSION}\\." | sort -V | tail -1
          else
            uds zarf tools registry ls ${TARGET_REPO}/core | grep "${FLAVOR}" | sort -V | tail -1
          fi
        setVariables:
          - name: LATEST_VERSION
      - description: "Extract unflavored version for git tag"
        cmd: echo ${LATEST_VERSION} | cut -d'-' -f1 # Extract version before any hyphen (e.g., "0.52.0" from "0.52.0-upstream")
        setVariables:
          - name: LATEST_CORE_TAG

  - name: latest-bundle-release
    inputs:
      configFile:
        description: "UDS_CONFIG file to use for the deployment"
    actions:
      - task: resolve-latest-core-release
      - description: "Create the latest version with bundle overrides"
        cmd: |
          # Create temp directory
          mkdir -p tmp/core-shim

          # Download latest release bundle
          curl -sSL https://raw.githubusercontent.com/defenseunicorns/uds-core/v${LATEST_CORE_TAG}/bundles/k3d-standard/uds-bundle.yaml -o tmp/core-shim/uds-bundle.yaml

          # Update the bundle with the latest version using yq
          uds zarf tools yq e -i "
            del(.packages[] | select(.name == \"core\").path) |
            .packages[] |= (select(.name == \"core\") |
            .repository = \"${TARGET_REPO}/core\" | .ref = \"${LATEST_VERSION}\")" \
            tmp/core-shim/uds-bundle.yaml

          # Create and deploy the bundle
          uds create tmp/core-shim --confirm --no-progress --architecture=${ZARF_ARCHITECTURE}
      - description: "Deploy the latest version from the bundle"
        cmd: |
          # Set UDS_CONFIG for bundle deployment
          export UDS_CONFIG="${{ .inputs.configFile }}"
          uds deploy tmp/core-shim/uds-bundle-k3d-core-demo-${UDS_ARCH}-${LATEST_CORE_TAG}.tar.zst --confirm --no-progress
      - description: "Clean up temporary files"
        cmd: rm -rf tmp/core-shim

  - name: latest-release-test-resources
    actions:
      - task: resolve-latest-core-release
      - description: "Fetch src/test from tagged release"
        cmd: |
          # Create temp directory
          mkdir -p tmp/test-shim

          # Clone only the src/test directory
          git clone --depth 1 --filter=blob:none --sparse --branch v${LATEST_CORE_TAG} https://github.com/defenseunicorns/uds-core.git tmp/test-shim/uds-core
          cd tmp/test-shim/uds-core
          git sparse-checkout set src/test tasks
      - description: "Deploy Latest Release Test Resources"
        cmd: uds run -f src/test/tasks.yaml create-deploy
        dir: tmp/test-shim/uds-core/
      - description: "Clean up temporary files"
        cmd: rm -rf tmp/test-shim

  - name: latest-slim-bundle-release
    actions:
      - description: "Deploy the latest UDS Core package release"
        cmd: uds deploy oci://ghcr.io/defenseunicorns/packages/uds/bundles/k3d-core-slim-dev:latest --set INSECURE_ADMIN_PASSWORD_GENERATION=true --confirm --no-progress

  - name: standard-package
    actions:
      - description: "Deploy the standard UDS Core zarf package"
        cmd: uds zarf package deploy build/zarf-package-core-${UDS_ARCH}-${VERSION}.tar.zst --confirm --components '*'

  - name: checkpoint-package
    actions:
      - description: "Deploy the checkpoint K3d + UDS Core Slim zarf package"
        cmd: uds zarf package deploy build/zarf-package-k3d-core-slim-dev-${UDS_ARCH}-${VERSION}.tar.zst --confirm
