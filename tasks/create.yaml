variables:
  - name: FLAVOR
    default: upstream

tasks:
  - name: standard-package
    description: "Create the UDS Core Zarf Package"
    actions:
      - task: pepr-build

      - description: "Create the UDS Core Standard Zarf Package"
        cmd: "uds zarf package create packages/standard --confirm --flavor ${FLAVOR}"

  - name: k3d-standard-bundle
    description: "Create the K3d-UDS Core Bundle"
    actions:
      - description: "Create the UDS Core Standard Bundle"
        cmd: "uds create bundles/k3d-standard --confirm --no-progress --architecture=${ZARF_ARCHITECTURE}"

  - name: istio-package
    description: "Create the UDS Core (Istio Only) Zarf Package"
    actions:
      - task: pepr-build

      - description: "Create the UDS Core Istio Zarf Package"
        cmd: "uds zarf package create packages/istio --confirm --flavor ${FLAVOR}"

  - name: k3d-istio-bundle
    description: "Create the K3d-UDS Core (Istio Only) Bundle"
    actions:
      - description: "Create the UDS Core Istio Only Bundle"
        cmd: "uds create bundles/k3d-istio --confirm --no-progress --architecture=${ZARF_ARCHITECTURE}"

  - name: k3d-single-bundle
    description: "Create the single package test Bundle"
    actions:
      - description: "Create the single package test Bundle"
        cmd: "uds create bundles/k3d-single --confirm --no-progress --architecture=${ZARF_ARCHITECTURE}"

  - name: single-package
    description: "Create a single Zarf Package, must set UDS_PKG environment variable"
    actions:
      - task: pepr-build

      - description: "Create the Pepr Zarf Package, if it exists"
        cmd: "uds zarf package create dist --confirm"

      - description: "Create the requested Zarf Package (must set UDS_PKG environment variable)"
        cmd: "uds zarf package create src/${UDS_PKG} --confirm --flavor ${FLAVOR}"

      - description: "Move to the loading dock"
        cmd: "mv build/zarf-package-uds-core-${UDS_PKG}-${UDS_ARCH}.tar.zst build/zarf-package-uds-core-single-${UDS_ARCH}-dev.tar.zst"

  - name: pepr-build
    description: "Build the UDS Core Pepr Module"
    actions:
      - description: "Build the UDS Core Pepr Module"
        cmd: |
          set -e
          rm -fr dist
          npm ci
          npx pepr build
