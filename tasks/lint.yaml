# Copyright 2024 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

includes:
  - remote: https://raw.githubusercontent.com/defenseunicorns/uds-common/v1.21.3/tasks/lint.yaml

tasks:
  - name: ensure-python-tools
    description: Install linting tool dependencies
    actions:
      - description: Check if pipx is installed
        cmd: |
          if ! command -v pipx; then
            echo "‚ö†Ô∏è  pipx is not installed."

            # Detect the OS and suggest the appropriate install method
            if [ "$(uname)" = "Darwin" ]; then
              echo "üí° Install pipx with: brew install pipx"
            elif [ -f /etc/debian_version ]; then
              echo "üí° Install pipx with: sudo apt update && sudo apt install pipx"
            else
              echo "üí° Please refer to your package manager to install pipx."
            fi
            exit 1
          fi
      - description: Ensure yamllint is installed
        cmd: |
          if ! pipx list | grep -q yamllint; then
            pipx install yamllint
          fi
      - description: Ensure codespell is installed
        cmd: |
          if ! pipx list | grep -q codespell; then
            pipx install codespell
          fi

  - name: fix
    description: "Fix formatting issues in the repo"
    actions:
      - description: Ensure python tools are installed
        task: ensure-python-tools
      - description: "Pepr Format"
        cmd: npx pepr format
      - description: Fix codespell lint issues
        cmd: |
          codespell || true
          codespell -w

  - name: check
    description: "Run linting checks"
    actions:
      - description: Ensure python tools are installed
        task: ensure-python-tools
      - description: install pepr deps
        cmd: npm ci
      - description: "Pepr Format check"
        cmd: npx pepr format --validate-only
      - description: yaml lint
        cmd: yamllint . -c .yamllint --no-warnings
      - description: codespell lint
        cmd: codespell
      - description: Install addlicense dep
        # renovate: datasource=github-tags depName=google/addlicense versioning=semver
        cmd: GOPATH="$HOME/go" go install github.com/google/addlicense@v1.1.1
      - description: license lint
        task: license
      - description: Run helm unittest on all charts
        task: helm-unittest

  - name: helm-unittest
    description: "Run helm unittest on all charts"
    actions:
      - description: Run helm unittest on all charts
        cmd: |
          failed=0
          for chart in $(find . -name Chart.yaml -type f -exec dirname {} \;); do
            if [ -d "$chart/tests" ]; then
              if ! helm unittest --color=true "$chart"; then
                failed=1
              fi
            else
              echo "No helm unittests configured for $chart"
            fi
          done
          exit $failed

  - name: license
    actions:
      - description: Lint for the SPDX license identifier being in source files
        task: remote:license

  - name: fix-license
    actions:
      - description: Add the SPDX license identifier to source files
        task: remote:fix-license
