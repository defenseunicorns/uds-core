on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - ".gitignore"
      - "LICENSE"
      - "**/*.md"
      - "**/*.json"
      - "**/*.png"
      - "**/*.svg"

permissions:
  id-token: write
  contents: read
  pull-requests: read 

defaults:
  run:
    # We need -e -o pipefail for consistency with GitHub Actions' default behavior
    shell: bash -e -o pipefail {0}


jobs: 
  check-paths:
    runs-on: ubuntu-latest
    outputs: 
      capabilities: ${{ steps.path-filter.outputs.changes }}
      bundles: ${{ steps.bundle-path-filter.outputs.changes }}
    steps:
    - name: Checkout the code
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1   

    - name: Check capability paths
      id: path-filter
      uses: dorny/paths-filter@v2
      with:
        filters: .github/filters.yaml
    - name: Debug output
      run: echo "${{ steps.path-filter.outputs.changes }}"  
 
    - name: Check bundle paths
      id: bundle-path-filter
      uses: dorny/paths-filter@v2
      with:
        filters: .github/bundle-filters.yaml
    - name: Debug output
      run: echo "${{ steps.bundle-path-filter.outputs.changes }}"

  build-and-test-capabilities:
    needs: check-paths
    strategy:
      matrix:
        capability: ${{ fromJSON(needs.check-paths.outputs.capabilities) }}
    uses: ./.github/workflows/build-and-test.yaml
    with:
      capability: ${{ matrix.capability }}
    secrets: inherit
    if: ${{ needs.check-paths.outputs.capabilities }} != "[]"

  # build-and-test-bundle:
  #   needs: [check-paths, build-and-test-capabilities]
  #   strategy:
  #     matrix:
  #       bundle: ${{ fromJSON(needs.check-paths.outputs.bundles) }}
  #   uses: ./.github/workflows/build-and-test-bundle.yaml
  #   secrets: inherit
  #   if: ${{ needs.check-paths.outputs.bundles }} != "[]"