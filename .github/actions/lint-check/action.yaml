# Copyright 2024 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

name: lint-check
description: "Check Project for Linting Errors"

runs:
  using: composite
  steps:
    - name: Environment setup
      uses: ./.github/actions/setup

    - name: Run Formatting Checks
      run: uds run lint-check --no-progress
      shell: bash

    - name: Check Autogenerated Files
      shell: bash
      run: |
        # We need a cluster for generating our CRD files - args used to simplify cluster setup
        k3d cluster create --k3s-arg "--disable=traefik@server:*" \
          --k3s-arg "--disable=metrics-server@server:*" \
          --k3s-arg "--disable=servicelb@server:*" \
          --k3s-arg "--disable=local-storage@server:*"

        # Generate CRD files
        uds run -f src/pepr/tasks.yaml gen-crds

        # Generate CACert values
        uds run -f src/keycloak/tasks.yaml cacert

        # Check for specific diffs
        DIFFS=false

        if [ ! -z "$(git status -s src/pepr/operator/crd/generated/ schemas/ docs/reference/configuration/custom-resources/)" ]; then
          # Diffs for CRDs
          DIFFS=true
          echo "Autogenerated CRD files are not up to date, please run \`uds run -f src/pepr/tasks.yaml gen-crds\` (with an active cluster) and commit the changes."
        fi

        if [ ! -z "$(git status -s src/istio/values/)" ]; then
          # Diffs for CACerts
          DIFFS=true
          echo "Autogenerated CACerts are not up to date, please run \`uds run -f src/keycloak/tasks.yaml cacert\` and commit the changes."
        fi

        if [ "${DIFFS}" = "true" ]; then
          echo "Ensure that all generated file changes are up to date and committed (see failures above)."
          exit 1
        fi
