---
title: Authorization Policies in Ambient Mode
sidebar:
  order: 2
---

## Overview

In an ambient mode service mesh environment, security is enforced using Istio AuthorizationPolicies. The UDS‑Core operator automatically generates these **ALLOW** policies based on your UDSPackage configuration. The generated policies ensure that only explicitly permitted traffic is allowed, enforcing per‑port access control for your applications. In addition to handling custom ingress rules (allow/expose), the operator also processes monitor configurations to protect monitoring endpoints (such as Prometheus metrics).

## Policy Generation Process

Authorization policies are dynamically created from the UDSPackage configuration through the following steps:

1. **Identify Applicable Rules:**
   - The operator processes three sections from the UDSPackage:
     - **Allow Rules:** Custom network rules defined under `spec.network.allow`.
     - **Expose Rules:** Rules defined under `spec.network.expose` for exposing services on an Istio Gateway.
     - **Monitor Rules:** Rules defined under `spec.monitor` to secure monitoring endpoints.
   - **Note:** Each rule is processed individually. There is no grouping or merging of rules with similar selectors. Even if a rule does not specify any port, a policy is generated that contains only a `from` clause applying the specified source restrictions.

2. **Process Allow Rules:**
   - Each rule in `spec.network.allow` is evaluated to determine its target ports (if provided) and remote source attributes:
     - If `remoteGenerated` is set to **IntraNamespace**, the source is set to the package’s namespace.
     - If a specific, non‑empty `remoteNamespace` is provided (and is not `"*"`), that namespace is used as the source.
     - If `remoteNamespace` is `"*"` or if `remoteGenerated` is set to **Anywhere**, no namespace restrictions are applied (i.e. the source is left empty).
     - If `remoteServiceAccount` is provided, it overrides the namespace‑based source by specifying a principal of the form `cluster.local/ns/<namespace>/sa/<serviceAccount>`.

3. **Process Expose Rules:**
   - Rules in `spec.network.expose` are processed similarly to allow rules, with these differences:
     - For expose rules, if `targetPort` is defined it is used; otherwise, the rule falls back to using `port`.
     - The source is determined based on the gateway setting:
       - If the gateway is set to **Admin**, the source is defined as a principal:
         ```
         cluster.local/ns/istio-admin-gateway/sa/admin-ingressgateway
         ```
       - Otherwise, the source is defined as:
         ```
         cluster.local/ns/istio-tenant-gateway/sa/tenant-ingressgateway
         ```
     - This means that, unlike allow rules, expose rules use principals for source identification rather than namespace restrictions.

4. **Process Monitor Rules:**
   - Each monitor entry in `spec.monitor` is processed separately.
   - A monitor rule must provide a valid selector (or podSelector) and a targetPort.
   - For each monitor, an individual AuthorizationPolicy is created to restrict access from the `monitoring` namespace to the specified port (e.g. for Prometheus metrics).

5. **Policy Naming Conventions:**
   - Each generated policy name is prefixed with `protect-` followed by the package name and a rule-specific name.
   - **Allow Rules:**
     - The rule-specific name is generated by prepending `ingress-` to either the provided description or a combination of selector values and remote attributes.
   - **Expose Rules:**
     - The rule-specific name is generated using the effective port, selector values (or "all" if no selector is provided), and the gateway setting. It follows the pattern:
       ```
       ingress-<port>-<selector>-istio-<gateway>-gateway
       ```
   - The final policy name reflects both the rule type (allow or expose) and the associated configuration.

6. **Policy Structure:**
   - Each generated policy uses the **ALLOW** action.
     - If port information is provided, the rule includes a `to` clause that specifies the allowed ports.
     - If no ports are defined, the rule contains only a `from` clause.
   - Metadata labels (including the package name and generation) are added for traceability.

## Example Use Cases

### Example 1: Allow Ingress from a Specific Namespace (No Selector)

**UDSPackage Configuration:**
```yaml
spec:
  network:
    allow:
      - direction: Ingress
        remoteNamespace: "external-app"
        port: 8080
```

**Generated AuthorizationPolicy:**
```yaml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: protect-my-app-ingress-external-app
  namespace: my-app-namespace
  labels:
    uds/package: my-app
    uds/generation: "1"
spec:
  action: ALLOW
  rules:
    - from:
        - source:
            namespaces: ["external-app"]
      to:
        - operation:
            ports: ["8080"]
```
*Note: The final policy name includes the ingress- prefix as generated by the code.*

### Example 2: Allow Ingress Only to a Specific Pod Selector

**UDSPackage Configuration:**
```yaml
spec:
  network:
    allow:
      - direction: Ingress
        remoteNamespace: "external-app"
        selector:
          app: "frontend"
        port: 8080
```

**Generated AuthorizationPolicy:**
```yaml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: protect-my-app-ingress-frontend
  namespace: my-app-namespace
  labels:
    uds/package: my-app
    uds/generation: "1"
spec:
  action: ALLOW
  selector:
    matchLabels:
      app: "frontend"
  rules:
    - from:
        - source:
            namespaces: ["external-app"]
      to:
        - operation:
            ports: ["8080"]
```

### Example 3: Intra-Namespace Rule Without Port
**UDSPackage Configuration (for a package named "loki" in the "loki" namespace):**

```yaml
spec:
  network:
    allow:
      - direction: Ingress
        remoteGenerated: IntraNamespace
```

**Generated AuthorizationPolicy:**

```yaml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: protect-loki-ingress-all
  namespace: loki
  labels:
    uds/package: loki
    uds/generation: "1"
spec:
  action: ALLOW
  rules:
    - from:
        - source:
            namespaces: ["loki"]
```

### Example 4: Allow Anywhere Rule (No Namespace Restriction)
**UDSPackage Configuration:**

```yaml
spec:
  network:
    allow:
      - direction: Ingress
        remoteGenerated: Anywhere
        port: 80
```

**Generated AuthorizationPolicy:**
```yaml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: protect-myapp-ingress-all
  namespace: my-namespace
  labels:
    uds/package: myapp
    uds/generation: "1"
spec:
  action: ALLOW
  rules:
    - from: []
      to:
        - operation:
            ports: ["80"]
```
*Note: When remoteGenerated is set to Anywhere, no namespace restrictions are applied, and the from clause may be empty.*

### Example 5: Expose Rule with Gateway Specification
**UDSPackage Configuration:**

```yaml
spec:
  network:
    expose:
      - port: 8080
        targetPort: 9090
        selector:
          app: "backend"
        gateway: Admin
```

**Generated AuthorizationPolicy:**
```yaml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: protect-my-app-ingress-9090-backend-istio-admin-gateway
  namespace: my-app-namespace
  labels:
    uds/package: my-app
    uds/generation: "1"
spec:
  action: ALLOW
  selector:
    matchLabels:
      app: "backend"
  rules:
    - from:
        - source:
            principals: ["cluster.local/ns/istio-admin-gateway/sa/admin-ingressgateway"]
      to:
        - operation:
            ports: ["9090"]
```

### Example 6: Monitor Rule for Securing a Metrics Endpoint
**UDSPackage Configuration:**

```yaml
spec:
  monitor:
    - description: Metrics
      podSelector:
        app.kubernetes.io/name: grafana
      portName: service
      selector:
        app.kubernetes.io/name: grafana
      targetPort: 3000
```

**Generated AuthorizationPolicy:**
```yaml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: protect-grafana-ingress-grafana-istio-tenant-gateway
  namespace: grafana
  labels:
    uds/package: grafana
    uds/generation: "1"
spec:
  action: ALLOW
  selector:
    matchLabels:
      app.kubernetes.io/name: grafana
  rules:
    - from:
        - source:
            namespaces: ["monitoring"]
      to:
        - operation:
            ports: ["3000"]
```
*Note: Each monitor rule produces its own policy to restrict access from the monitoring namespace.*

## Summary
- The UDS‑Core operator automatically generates ALLOW Istio AuthorizationPolicies based on your UDSPackage configuration.

- Policies are generated for rules defined in the allow, expose, and monitor blocks, with each rule processed individually.

- Allow rules determine the source based on remote namespace settings, remoteGenerated, and remoteServiceAccount (which specifies a principal).

- Expose rules set the source using principals based on the specified gateway.

- Monitor rules produce individual policies to secure monitoring endpoints.

- Generated policy names incorporate an "ingress-" naming pattern along with metadata for traceability.
