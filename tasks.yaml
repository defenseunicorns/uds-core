variables:
  - name: WORK_DIR
    default: packages/standard
  - name: ZARF_VER
    default: "v0.31.0"
  - name: NODE_VER
    default: "v20.9.0"
  - name: BUILD_DIR
    default: "build"

tasks:
  - name: uds-core
    actions:
      - task:
          name: make-build-dir  
      - task:
          name: set-env  
      - task:
          name: install-deps
      - task: 
          name: pepr-build
      - task: 
          name: zarf-create 
      - task:
          name: create-testbed 
      - task:
          name: zarf-init

      # Is there a better way currently? env?
      - name: set package to deploy
        mute: true
        cmd:  echo "uds-core"
        setVariables:
          - name: DEPLOY_PACKAGE
            sensitive: false
      - task:
          name: zarf-deploy

      - name: Inject tls certificate
        cmd: |
          npm ci
          npx --yes ts-node examples/tls-certs.ts

      # Is there a better way currently? env?      
      - description: set test url
        mute: true
        cmd:  echo "neuvector.admin.uds.dev"
        setVariables:
          - name: URL
            sensitive: false
      - task:
          name: wait-for-network
          # Env does not seem to be working as i hoped
          # env: 
          #   - url="neuvector.admin.uds.dev"



  ### All Tasks below here are candidates to be made common beyond this repo ###


  - name: make-build-dir
    actions:
      - cmd: mkdir -p ${ZARF_VAR_BUILD_DIR}

  # Setup ENV
  - name: set-env
    actions:
      - cmd: | 
              ARCH=$(uname -m)
              [ "$ARCH" = "x86_64" ] && ARCH="amd64"
              echo $ARCH
        setVariables:
          - name: ARCH
            sensitive: false
      - cmd: | 
              PLATFORM=$(uname -s)
              echo $PLATFORM
        setVariables:
          - name: PLATFORM
            sensitive: false

  - name: install-deps
    actions:
      - description: Setup Zarf
        cmd: |
          curl -sL --output zarf "https://github.com/defenseunicorns/zarf/releases/download/${ZARF_VAR_ZARF_VER}/zarf_${ZARF_VAR_ZARF_VER}_${PLATFORM}_${ARCH}"
          chmod +x zarf

  - name: zarf-create
    actions:
      - cmd: ./zarf package create ${ZARF_VAR_WORK_DIR} --confirm -o ${ZARF_VAR_BUILD_DIR}

  - name: zarf-deploy
    actions:
      - cmd: ./zarf package deploy ${ZARF_VAR_BUILD_DIR}/zarf-package-${DEPLOY_PACKAGE}-* --confirm 
  - name: zarf-init
    actions:
      - cmd: ./zarf package deploy oci://ghcr.io/defenseunicorns/packages/init:${ZARF_VAR_ZARF_VER}-$ARCH --confirm
 
  - name: create-testbed
    actions:
      - cmd: ./zarf package deploy oci://defenseunicorns/uds-k3d:0.1.10-multi --confirm

  - name: wait-for-network
    actions: 
      - description: Wait for test app to be accessible
        wait:
          network:
            protocol: https
            address: $URL

  - name: pepr-build
    actions:
      - description: build pepr module
        cmd: |     
          npm ci
          npx pepr build


