kind: ZarfPackageConfig
metadata:
  name: core-slim-dev
  description: "UDS Core (Istio, UDS Operator and Keycloak)"
  authors: "Defense Unicorns - Product"
  # x-release-please-start-version
  version: "0.25.2"
  # x-release-please-end

components:
  - name: uds-operator-config
    required: true
    import:
      path: ../../src/uds-core-config

  # CRDs
  - name: prometheus-operator-crds
    required: true
    import:
      path: ../../src/prometheus-stack

  # Istio
  - name: istio-controlplane
    required: true
    import:
      path: ../../src/istio

  - name: istio-admin-gateway
    required: true
    import:
      path: ../../src/istio

  - name: istio-tenant-gateway
    required: true
    import:
      path: ../../src/istio

  - name: istio-passthrough-gateway
    required: false
    import:
      path: ../../src/istio

  # Pepr the world
  - name: pepr-uds-core
    required: true
    import:
      path: ../../dist
      name: module
    charts:
      - name: module
        valuesFiles:
          - ../../src/pepr/values.yaml
    actions:
      onDeploy:
        before:
          - cmd: ./zarf tools kubectl annotate secret -n pepr-system pepr-uds-core-api-token meta.helm.sh/release-name=module --overwrite || true
          - cmd: ./zarf tools kubectl annotate secret -n pepr-system pepr-uds-core-module meta.helm.sh/release-name=module --overwrite || true
          - cmd: ./zarf tools kubectl annotate secret -n pepr-system pepr-uds-core-tls meta.helm.sh/release-name=module --overwrite || true
          - cmd: ./zarf tools kubectl annotate serviceaccount -n pepr-system pepr-uds-core meta.helm.sh/release-name=module --overwrite || true
          - cmd: ./zarf tools kubectl annotate clusterrolebinding pepr-uds-core meta.helm.sh/release-name=module --overwrite || true
          - cmd: ./zarf tools kubectl annotate clusterrole pepr-uds-core meta.helm.sh/release-name=module --overwrite || true
          - cmd: ./zarf tools kubectl annotate role -n pepr-system pepr-uds-core-store meta.helm.sh/release-name=module --overwrite || true
          - cmd: ./zarf tools kubectl annotate rolebinding -n pepr-system pepr-uds-core-store meta.helm.sh/release-name=module --overwrite || true
          - cmd: ./zarf tools kubectl annotate service -n pepr-system pepr-uds-core meta.helm.sh/release-name=module --overwrite || true
          - cmd: ./zarf tools kubectl annotate service -n pepr-system pepr-uds-core-watcher meta.helm.sh/release-name=module --overwrite || true
          - cmd: ./zarf tools kubectl annotate deployment -n pepr-system pepr-uds-core meta.helm.sh/release-name=module --overwrite || true
          - cmd: ./zarf tools kubectl annotate deployment -n pepr-system pepr-uds-core-watcher meta.helm.sh/release-name=module --overwrite || true
          - cmd: ./zarf tools kubectl annotate mutatingwebhookconfiguration -n pepr-system pepr-uds-core meta.helm.sh/release-name=module --overwrite || true
          - cmd: ./zarf tools kubectl annotate validatingwebhookconfiguration -n pepr-system pepr-uds-core meta.helm.sh/release-name=module --overwrite || true

  # Keycloak
  - name: keycloak
    required: true
    import:
      path: ../../src/keycloak
